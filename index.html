<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Blitz Nexus Pro 3.0 - AI-Enhanced Scalping</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap');
        :root {
            --orange: #ff6b35; --blue: #00d4ff; --purple: #627eea; --btc: #f7931a;
            --green: #00ff88; --yellow: #ffb800; --red: #ff4757; --dark: #0a0e1a;
            --panel: rgba(255,107,53,0.03); --border: rgba(255,107,53,0.3);
            --text: #ffffff; --text2: rgba(255,255,255,0.7); --text3: rgba(255,255,255,0.5);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Rajdhani',sans-serif; background:linear-gradient(135deg,var(--dark),#050810); 
               color:var(--text); min-height:100vh; }
        .header { background:linear-gradient(90deg,var(--orange),var(--blue)); padding:15px; text-align:center; 
                  box-shadow:0 4px 20px rgba(255,107,53,0.3); position:relative; }
        .header h1 { font-family:'Orbitron'; font-size:2rem; font-weight:700; margin:0; 
                     text-transform:uppercase; letter-spacing:2px; }
        .header .subtitle { font-size:0.9rem; margin-top:5px; opacity:0.9; }
        .live { position:absolute; top:15px; right:20px; display:flex; align-items:center; 
                background:rgba(0,0,0,0.3); padding:6px 12px; border-radius:20px; 
                border:2px solid var(--green); font-size:0.8rem; }
        .dot { width:6px; height:6px; border-radius:50%; background:var(--green); 
               margin-right:6px; animation:pulse 2s infinite; }
        .controls { background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                   margin:15px; padding:15px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; }
        .control-group { display:flex; align-items:center; gap:10px; }
        .toggle-btn { background:linear-gradient(45deg,var(--orange),var(--blue)); border:none; 
                     border-radius:6px; padding:8px 15px; color:#fff; font-family:'Orbitron'; 
                     font-size:0.7rem; font-weight:700; cursor:pointer; text-transform:uppercase; transition:background 0.2s; }
        .toggle-btn.active { background:linear-gradient(45deg,var(--green),#00aa66); }
        .news-btn { background:linear-gradient(45deg,var(--red),#cc3333); }
        .news-btn.active { background:linear-gradient(45deg,#ff0000,#990000); animation:flash 1s infinite; }
        .test-audio { background:linear-gradient(45deg,var(--purple),#4a5bbb); }
        .acknowledge-btn { background:linear-gradient(45deg,var(--yellow),#ff8800); }
        .reset-btn { background:linear-gradient(45deg,var(--red),#cc0000); }
        .performance-panel { background:var(--panel); border:2px solid var(--green); border-radius:12px; 
                            margin:15px; padding:15px; position:relative; }
        .perf-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .perf-title { font-family:'Orbitron'; color:var(--green); font-size:1rem; }
        .reset-analytics { background:linear-gradient(45deg,var(--red),#aa0000); border:none; 
                          border-radius:6px; padding:5px 10px; color:#fff; font-family:'Orbitron'; 
                          font-size:0.6rem; font-weight:700; cursor:pointer; text-transform:uppercase; }
        .reset-analytics:hover { transform:translateY(-1px); }
        .perf-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:15px; }
        .perf-stat { background:rgba(0,0,0,0.4); border-radius:8px; padding:10px; text-align:center; }
        .perf-value { font-family:'Orbitron'; font-size:1.2rem; font-weight:700; color:var(--green); }
        .perf-label { font-size:0.7rem; color:var(--text2); margin-top:3px; }
        .sessions { background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                    margin:15px; padding:15px; }
        .sessions h2 { font-family:'Orbitron'; color:var(--orange); text-align:center; 
                       margin-bottom:15px; font-size:1.2rem; }
        .sessions-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
                         gap:10px; margin-bottom:10px; }
        .session { background:rgba(0,0,0,0.3); border:1px solid var(--border); 
                   border-radius:8px; padding:10px; text-align:center; }
        .session.open { border-color:var(--green); box-shadow:0 0 10px rgba(0,255,136,0.2); }
        .session-name { font-family:'Orbitron'; font-weight:700; margin-bottom:5px; }
        .session-status { font-size:0.9rem; margin-bottom:5px; text-transform:uppercase; font-weight:600; }
        .status-open { color:var(--green); }
        .status-closed { color:var(--red); }
        .session-time { font-size:0.8rem; color:var(--text2); margin-bottom:8px; }
        .countdown { font-family:'Orbitron'; font-size:0.9rem; color:var(--yellow); }
        .container { display:grid; gap:15px; padding:15px; }
        @media (min-width:1024px) { .container { grid-template-columns:1fr 1fr; } }
        .panel { background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                 padding:15px; display:flex; flex-direction:column; }
        .btc-panel { border-color:var(--btc); box-shadow:0 0 20px rgba(247,147,26,0.1); }
        .eth-panel { border-color:var(--purple); box-shadow:0 0 20px rgba(98,126,234,0.1); }
        .asset-header { display:flex; justify-content:space-between; align-items:center; 
                        margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid var(--border); }
        .asset-title { font-family:'Orbitron'; font-size:1.3rem; font-weight:700; }
        .btc-title { color:var(--btc); }
        .eth-title { color:var(--purple); }
        .status { display:flex; flex-direction:column; align-items:flex-end; font-size:0.8rem; }
        .status-dot { width:6px; height:6px; border-radius:50%; background:var(--green); 
                      margin-bottom:3px; animation:pulse 2s infinite; }
        .price-display { background:rgba(0,0,0,0.4); border-radius:8px; padding:12px; 
                         margin-bottom:15px; text-align:center; }
        .current-price { font-family:'Orbitron'; font-size:1.5rem; font-weight:700; margin-bottom:6px; }
        .price-change { font-size:0.9rem; font-weight:600; }
        .price-up { color:var(--green); }
        .price-down { color:var(--red); }
        .section { margin-bottom:15px; }
        .section-title { font-family:'Orbitron'; font-size:1rem; color:var(--orange); 
                         margin-bottom:10px; text-transform:uppercase; }
        .item { background:rgba(0,0,0,0.2); border:1px solid var(--border); 
                border-radius:6px; padding:8px; margin-bottom:6px; }
        .item-header { display:flex; justify-content:space-between; margin-bottom:4px; }
        .type { font-family:'Orbitron'; font-size:0.8rem; font-weight:600; text-transform:uppercase; }
        .bullish { color:var(--green); }
        .bearish { color:var(--red); }
        .strength { font-size:0.7rem; padding:2px 6px; border-radius:3px; }
        .high { background:rgba(0,255,136,0.2); color:var(--green); }
        .medium { background:rgba(255,184,0,0.2); color:var(--yellow); }
        .range { font-family:'Orbitron'; font-weight:600; margin-bottom:3px; }
        .details { font-size:0.7rem; color:var(--text2); }
        .timeframe { font-size:0.6rem; background:var(--orange); color:#000; padding:1px 4px; 
                    border-radius:3px; font-weight:700; }
        .status-indicator { font-size:0.6rem; padding:1px 4px; border-radius:3px; font-weight:700; }
        .testing { background:var(--yellow); color:#000; }
        .respected { background:var(--green); color:#000; }
        .disrespected { background:var(--red); color:#fff; }
        .fresh { background:var(--blue); color:#000; }
        .filled { background:var(--red); color:#fff; }
        .partial { background:var(--yellow); color:#000; }
        .trade-panel { background:linear-gradient(135deg,rgba(255,107,53,0.08),rgba(0,212,255,0.08)); 
                       border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:15px; }
        .trade-title { font-family:'Orbitron'; color:var(--orange); margin-bottom:10px; 
                       text-transform:uppercase; font-size:0.9rem; }
        .levels { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
        .level { background:rgba(0,0,0,0.3); border:1px solid var(--border); 
                 border-radius:5px; padding:6px; text-align:center; }
        .label { font-size:0.7rem; color:var(--text2); margin-bottom:2px; text-transform:uppercase; }
        .value { font-family:'Orbitron'; font-size:0.8rem; font-weight:600; }
        .entry .value { color:var(--blue); }
        .target .value { color:var(--green); }
        .stop .value { color:var(--red); }
        .rr .value { color:var(--yellow); }
        .trade-status { background:rgba(0,0,0,0.5); border-radius:5px; padding:8px; margin:8px 0; 
                       text-align:center; border:2px solid transparent; }
        .trade-active { border-color:var(--green); }
        .trade-stopped { border-color:var(--red); }
        .trade-target { border-color:var(--green); }
        .trade-invalid { border-color:var(--yellow); }
        .trade-breakeven { border-color:var(--blue); }
        .confluence { background:linear-gradient(135deg,var(--orange),var(--blue)); 
                      border-radius:10px; padding:10px; text-align:center; margin-bottom:10px; }
        .conf-label { font-size:0.7rem; margin-bottom:3px; }
        .conf-number { font-family:'Orbitron'; font-size:1.8rem; font-weight:700; margin-bottom:2px; }
        .conf-rating { font-size:0.8rem; font-weight:600; text-transform:uppercase; }
        .win-prob { font-size:0.7rem; margin-top:3px; opacity:0.9; }
        .alert { background:linear-gradient(45deg,var(--yellow),var(--orange)); border:none; 
                 border-radius:6px; padding:6px 12px; color:#000; font-family:'Orbitron'; 
                 font-size:0.7rem; font-weight:700; cursor:pointer; width:100%; 
                 text-transform:uppercase; margin-top:8px; }
        .alert:hover { transform:translateY(-1px); }
        .alert.pulsing { animation:alertPulse 1s infinite; }
        .workspace { position:fixed; bottom:15px; left:15px; right:15px; height:140px; 
                     background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                     display:flex; flex-direction:column; z-index:1000; }
        .ws-header { padding:8px 15px; border-bottom:1px solid var(--border); 
                     font-family:'Orbitron'; color:var(--orange); display:flex; 
                     justify-content:space-between; align-items:center; font-size:0.8rem; }
        .ws-feed { flex-grow:1; padding:6px 15px; overflow-y:auto; font-size:0.75rem; }
        .message { margin-bottom:4px; padding:3px 5px; background:rgba(0,0,0,0.3); 
                   border-radius:4px; border-left:2px solid var(--orange); }
        .timestamp { color:var(--text3); font-size:0.65rem; margin-bottom:1px; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
        @keyframes flash { 0%,100%{opacity:1} 50%{opacity:0.3} }
        @keyframes alertPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)} }
        @media (max-width:768px) { 
            .header h1 { font-size:1.4rem; }
            .sessions-grid { grid-template-columns:1fr 1fr; }
            .levels { grid-template-columns:1fr; }
            .workspace { position:relative; bottom:auto; left:auto; right:auto; margin-top:15px; }
            .controls { flex-direction:column; }
            .perf-grid { grid-template-columns:repeat(2,1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="live"><div class="dot"></div>LIVE AI</div>
        <h1>Crypto Blitz Nexus Pro 3.0</h1>
        <div class="subtitle">Self-Learning AI Scalping Terminal - Bulletproof Breakeven Strategy</div>
    </div>

    <!-- Enhanced Control Panel with Audio Management -->
    <div class="controls">
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">Risk Mode:</label>
            <button class="toggle-btn active" id="riskMode" onclick="toggleRiskMode()">CONSERVATIVE</button>
        </div>
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">News Alert:</label>
            <button class="toggle-btn news-btn" id="newsMode" onclick="toggleNewsMode()">NORMAL</button>
        </div>
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">Audio:</label>
            <button class="toggle-btn test-audio" onclick="testAudio('low')">TEST</button>
            <button class="toggle-btn acknowledge-btn" id="acknowledgeBtn" onclick="acknowledgeAlert()" style="display:none">SILENCE</button>
        </div>
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">Scanning:</label>
            <span id="scanRate" style="color:var(--green);">ACTIVE</span>
        </div>
        <!-- Trade Log Export Feature -->
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">Trade Log Export:</label>
            <button class="toggle-btn" onclick="exportTrades('csv')">Export CSV</button>
            <button class="toggle-btn" onclick="exportTrades('json')">Export JSON</button>
        </div>
        <!-- Live/Sim Mode Switch -->
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">Mode:</label>
            <button class="toggle-btn" id="modeSwitch" onclick="toggleLiveMode()">SIM MODE</button>
        </div>
    </div>

    <!-- NEW: Performance Dashboard with Reset Button -->
    <div class="performance-panel">
        <div class="perf-header">
            <h3 class="perf-title">📊 AI PERFORMANCE ANALYTICS - BREAKEVEN STRATEGY</h3>
            <button class="reset-analytics" onclick="resetPerformanceAnalytics()">🔄 RESET STATS</button>
        </div>
        <div class="perf-grid">
            <div class="perf-stat">
                <div class="perf-value" id="totalTrades">0</div>
                <div class="perf-label">Total Trades</div>
            </div>
            <div class="perf-stat">
                <div class="perf-value" id="winRate">0%</div>
                <div class="perf-label">Win Rate</div>
            </div>
            <div class="perf-stat">
                <div class="perf-value" id="profitFactor">0.00</div>
                <div class="perf-label">Profit Factor</div>
            </div>
            <div class="perf-stat">
                <div class="perf-value" id="avgWin">$0</div>
                <div class="perf-label">Avg Win</div>
            </div>
            <div class="perf-stat">
                <div class="perf-value" id="avgLoss">$0</div>
                <div class="perf-label">Avg Loss</div>
            </div>
            <div class="perf-stat">
                <div class="perf-value" id="breakevenRate">0%</div>
                <div class="perf-label">Breakeven Rate</div>
            </div>
        </div>
    </div>

    <div class="sessions">
        <h2>🌍 Global Trading Sessions</h2>
        <div class="sessions-grid" id="sessionsGrid"></div>
        <div style="text-align:center;margin-top:10px;font-family:Orbitron;font-size:0.8rem;" id="nextInfo"></div>
    </div>

    <div class="container">
        <div class="panel btc-panel">
            <div class="asset-header">
                <div class="asset-title btc-title">BITCOIN</div>
                <div class="status"><div class="status-dot"></div>AI ACTIVE</div>
            </div>
            <div class="price-display">
                <div class="current-price btc-title" id="btc-price">Loading...</div>
                <div class="price-change" id="btc-change">Loading...</div>
            </div>
            <div class="section">
                <div class="section-title">📊 Order Blocks (AI-Filtered)</div>
                <div id="btc-ob"></div>
            </div>
            <div class="section">
                <div class="section-title">⚡ Fair Value Gaps (AI-Filtered)</div>
                <div id="btc-fvg"></div>
            </div>
            <div class="trade-panel">
                <div class="trade-title">🎯 AI Trade Setup</div>
                <div class="trade-status" id="btc-status">Scanning for optimal entry...</div>
                <div class="levels">
                    <div class="level entry"><div class="label">Entry</div><div class="value" id="btc-entry">Calculating...</div></div>
                    <div class="level stop"><div class="label">Stop</div><div class="value" id="btc-stop">Calculating...</div></div>
                    <div class="level target"><div class="label">Target 1</div><div class="value" id="btc-t1">Calculating...</div></div>
                    <div class="level target"><div class="label">Target 2</div><div class="value" id="btc-t2">Calculating...</div></div>
                    <div class="level rr"><div class="label">R:R</div><div class="value" id="btc-rr">1:2.5</div></div>
                    <div class="level"><div class="label">P&L</div><div class="value" id="btc-pnl">$0.00</div></div>
                </div>
                <button class="alert" id="btc-alert" onclick="executeSetup('BTC')" style="display:none">🚨 AI SETUP READY</button>
            </div>
            <div class="confluence">
                <div class="conf-label">AI Confidence Score</div>
                <div class="conf-number" id="btc-conf">--</div>
                <div class="conf-rating" id="btc-rating">READY</div>
                <div class="win-prob" id="btc-prob">Historical Win Rate: --%</div>
            </div>
        </div>

        <div class="panel eth-panel">
            <div class="asset-header">
                <div class="asset-title eth-title">ETHEREUM</div>
                <div class="status"><div class="status-dot"></div>AI ACTIVE</div>
            </div>
            <div class="price-display">
                <div class="current-price eth-title" id="eth-price">Loading...</div>
                <div class="price-change" id="eth-change">Loading...</div>
            </div>
            <div class="section">
                <div class="section-title">📊 Order Blocks (AI-Filtered)</div>
                <div id="eth-ob"></div>
            </div>
            <div class="section">
                <div class="section-title">⚡ Fair Value Gaps (AI-Filtered)</div>
                <div id="eth-fvg"></div>
            </div>
            <div class="trade-panel">
                <div class="trade-title">🎯 AI Trade Setup</div>
                <div class="trade-status" id="eth-status">Scanning for optimal entry...</div>
                <div class="levels">
                    <div class="level entry"><div class="label">Entry</div><div class="value" id="eth-entry">Calculating...</div></div>
                    <div class="level stop"><div class="label">Stop</div><div class="value" id="eth-stop">Calculating...</div></div>
                    <div class="level target"><div class="label">Target 1</div><div class="value" id="eth-t1">Calculating...</div></div>
                    <div class="level target"><div class="label">Target 2</div><div class="value" id="eth-t2">Calculating...</div></div>
                    <div class="level rr"><div class="label">R:R</div><div class="value" id="eth-rr">1:2.8</div></div>
                    <div class="level"><div class="label">P&L</div><div class="value" id="eth-pnl">$0.00</div></div>
                </div>
                <button class="alert" id="eth-alert" onclick="executeSetup('ETH')" style="display:none">🚨 AI SETUP READY</button>
            </div>
            <div class="confluence">
                <div class="conf-label">AI Confidence Score</div>
                <div class="conf-number" id="eth-conf">--</div>
                <div class="conf-rating" id="eth-rating">READY</div>
                <div class="win-prob" id="eth-prob">Historical Win Rate: --%</div>
            </div>
        </div>
    </div>

    <div class="workspace">
        <div class="ws-header">🤖 AI Trade Journal - Bulletproof Edition <span style="color:#00ff88" id="connectionStatus">🟢 READY</span></div>
        <div class="ws-feed" id="feed">
            <div class="message"><div class="timestamp">00:00</div><strong>AI:</strong> Bulletproof breakeven strategy initialized - All issues resolved.</div>
        </div>
    </div>

    <script>
        // ===== CRYPTO NEXUS BLITZ PRO 3.0 - BULLETPROOF EDITION =====
        // ... [All your existing JavaScript remains unchanged up to the end] ...

        // ===== TRADE LOG EXPORT FEATURE =====
        function exportTrades(type) {
            const data = tradeDatabase.trades;
            if (!data || data.length === 0) {
                addTradeMessage('⚠️ No trades to export!', 'System');
                return;
            }
            let filename = `nexus_trades_${new Date().toISOString().split('T')[0]}.${type}`;
            let blob, url;
            if (type === 'csv') {
                // Convert to CSV
                const headers = Object.keys(data[0]);
                const csvRows = [
                    headers.join(','),
                    ...data.map(row => headers.map(h => 
                        JSON.stringify(row[h] ?? '')
                    ).join(','))
                ];
                blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            } else {
                // JSON export
                blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            }
            url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            addTradeMessage(`⬇️ Trade log exported as ${type.toUpperCase()}`, 'System');
        }

        // ===== LIVE/SIM MODE SWITCH =====
        let liveMode = false; // Default is SIM

        function loadLiveMode() {
            const saved = localStorage.getItem('nexusLiveMode');
            liveMode = saved === 'true';
            updateLiveModeUI();
        }

        function toggleLiveMode() {
            liveMode = !liveMode;
            localStorage.setItem('nexusLiveMode', liveMode);
            updateLiveModeUI();
            addTradeMessage(`⚡ Mode changed: ${liveMode ? 'LIVE' : 'SIMULATION'} MODE`, 'System');
        }

        function updateLiveModeUI() {
            const btn = document.getElementById('modeSwitch');
            if (btn) {
                btn.textContent = liveMode ? 'LIVE MODE' : 'SIM MODE';
                btn.className = 'toggle-btn' + (liveMode ? ' active' : '');
                btn.style.background = liveMode
                    ? 'linear-gradient(45deg,var(--green),#00aa66)'
                    : 'linear-gradient(45deg,var(--orange),var(--blue))';
            }
        }

        // ===== SAFETY CHECK FOR LIVE ORDERS =====
        // Example safety snippet for future broker integration:
        // if (!liveMode) {
        //     addTradeMessage('🛑 Order blocked: Not in LIVE mode!', 'System');
        //     return;
        // }
        // // Place real order here ONLY if liveMode == true

        // ===== PATCH: Ensure Live/Sim Mode state is loaded on startup =====
        function init() {
            // ...existing code...
            loadLiveMode(); // <-- add this line to load mode on startup
            // ...existing code...
            connectBinance();
            connectCoinbase();
            updateSessions();
            loadTradeDatabase();
            priceHistory = {
                btc: [{price: 60000, change: 1, time: Date.now()}],
                eth: [{price: 3000, change: 1, time: Date.now()}]
            };
            setInterval(() => adaptiveScan(), 3000);
            setInterval(updateSessions, 1000);
            setInterval(() => updatePersistentLevels(), 15000);
            setInterval(() => updatePerformanceDisplay(), 5000);
            setTimeout(() => {
                if (currentPrices.btc > 0 && currentPrices.eth > 0) {
                    updatePersistentLevels();
                }
            }, 3000);
            addTradeMessage('🛡️ Bulletproof Breakeven Strategy Initialized - All fixes applied', 'AI');
            addTradeMessage('📊 Signal generation: 4-8 per day | OB/FVG: Always visible | Trade monitoring: Real-time', 'AI');
        }

        // ... [All your remaining JavaScript remains unchanged] ...

        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            if (coinbaseWS) coinbaseWS.close();
        });
    </script>
</body>
</html>
