<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Blitz Nexus Pro 3.6 - AI-Enhanced Scalping (FIXED)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap');
        
        :root {
            --orange: #ff6b35; --blue: #00d4ff; --purple: #627eea; --btc: #f7931a;
            --green: #00ff88; --yellow: #ffb800; --red: #ff4757; --dark: #0a0e1a;
            --panel: rgba(255,107,53,0.03); --border: rgba(255,107,53,0.3);
            --text: #ffffff; --text2: rgba(255,255,255,0.7); --text3: rgba(255,255,255,0.5);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Rajdhani',sans-serif; background:linear-gradient(135deg,var(--dark),#050810); 
               color:var(--text); min-height:100vh; }

        .header { background:linear-gradient(90deg,var(--orange),var(--blue)); padding:15px; text-align:center; 
                  box-shadow:0 4px 20px rgba(255,107,53,0.3); position:relative; }
        .header h1 { font-family:'Orbitron'; font-size:2rem; font-weight:700; margin:0; 
                     text-transform:uppercase; letter-spacing:2px; }
        .header .subtitle { font-size:0.9rem; margin-top:5px; opacity:0.9; }
        .live { position:absolute; top:15px; right:20px; display:flex; align-items:center; 
                background:rgba(0,0,0,0.3); padding:6px 12px; border-radius:20px; 
                border:2px solid var(--green); font-size:0.8rem; }
        .dot { width:6px; height:6px; border-radius:50%; background:var(--green); 
               margin-right:6px; animation:pulse 2s infinite; }

        .controls { background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                   margin:15px; padding:15px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; }
        .control-group { display:flex; align-items:center; gap:10px; }
        .toggle-btn { background:linear-gradient(45deg,var(--orange),var(--blue)); border:none; 
                     border-radius:6px; padding:8px 15px; color:#fff; font-family:'Orbitron'; 
                     font-size:0.7rem; font-weight:700; cursor:pointer; text-transform:uppercase; }
        .toggle-btn.active { background:linear-gradient(45deg,var(--green),#00aa66); }
        .news-btn { background:linear-gradient(45deg,var(--red),#cc3333); }
        .news-btn.active { background:linear-gradient(45deg,#ff0000,#990000); animation:flash 1s infinite; }
        .test-audio { background:linear-gradient(45deg,var(--purple),#4a5bbb); }
        .acknowledge-btn { background:linear-gradient(45deg,var(--yellow),#ff8800); }
        .reset-btn { background:linear-gradient(45deg,var(--red),#cc0000); }

        .performance-panel { background:var(--panel); border:2px solid var(--green); border-radius:12px; 
                            margin:15px; padding:15px; position:relative; }
        .perf-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .perf-title { font-family:'Orbitron'; color:var(--green); font-size:1rem; }
        .reset-analytics { background:linear-gradient(45deg,var(--red),#aa0000); border:none; 
                          border-radius:6px; padding:5px 10px; color:#fff; font-family:'Orbitron'; 
                          font-size:0.6rem; font-weight:700; cursor:pointer; text-transform:uppercase; }
        .reset-analytics:hover { transform:translateY(-1px); }
        .perf-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:15px; }
        .perf-stat { background:rgba(0,0,0,0.4); border-radius:8px; padding:10px; text-align:center; }
        .perf-value { font-family:'Orbitron'; font-size:1.2rem; font-weight:700; color:var(--green); }
        .perf-label { font-size:0.7rem; color:var(--text2); margin-top:3px; }

        .sessions { background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                    margin:15px; padding:15px; }
        .sessions h2 { font-family:'Orbitron'; color:var(--orange); text-align:center; 
                       margin-bottom:15px; font-size:1.2rem; }
        .sessions-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
                         gap:10px; margin-bottom:10px; }
        .session { background:rgba(0,0,0,0.3); border:1px solid var(--border); 
                   border-radius:8px; padding:10px; text-align:center; }
        .session.open { border-color:var(--green); box-shadow:0 0 10px rgba(0,255,136,0.2); }
        .session-name { font-family:'Orbitron'; font-weight:700; margin-bottom:5px; }
        .session-status { font-size:0.9rem; margin-bottom:5px; text-transform:uppercase; font-weight:600; }
        .status-open { color:var(--green); }
        .status-closed { color:var(--red); }
        .session-time { font-size:0.8rem; color:var(--text2); margin-bottom:8px; }
        .countdown { font-family:'Orbitron'; font-size:0.9rem; color:var(--yellow); }

        .container { display:grid; gap:15px; padding:15px; }
        @media (min-width:1024px) { .container { grid-template-columns:1fr 1fr; } }
        
        .panel { background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                 padding:15px; display:flex; flex-direction:column; }
        .btc-panel { border-color:var(--btc); box-shadow:0 0 20px rgba(247,147,26,0.1); }
        .eth-panel { border-color:var(--purple); box-shadow:0 0 20px rgba(98,126,234,0.1); }
        
        .asset-header { display:flex; justify-content:space-between; align-items:center; 
                        margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid var(--border); }
        .asset-title { font-family:'Orbitron'; font-size:1.3rem; font-weight:700; }
        .btc-title { color:var(--btc); }
        .eth-title { color:var(--purple); }
        .status { display:flex; flex-direction:column; align-items:flex-end; font-size:0.8rem; }
        .status-dot { width:6px; height:6px; border-radius:50%; background:var(--green); 
                      margin-bottom:3px; animation:pulse 2s infinite; }

        .price-display { background:rgba(0,0,0,0.4); border-radius:8px; padding:12px; 
                         margin-bottom:15px; text-align:center; }
        .current-price { font-family:'Orbitron'; font-size:1.5rem; font-weight:700; margin-bottom:6px; }
        .price-change { font-size:0.9rem; font-weight:600; }
        .price-up { color:var(--green); }
        .price-down { color:var(--red); }

        .section { margin-bottom:15px; }
        .section-title { font-family:'Orbitron'; font-size:1rem; color:var(--orange); 
                         margin-bottom:10px; text-transform:uppercase; }
        .item { background:rgba(0,0,0,0.2); border:1px solid var(--border); 
                border-radius:6px; padding:8px; margin-bottom:6px; }
        .item-header { display:flex; justify-content:space-between; margin-bottom:4px; }
        .type { font-family:'Orbitron'; font-size:0.8rem; font-weight:600; text-transform:uppercase; }
        .bullish { color:var(--green); }
        .bearish { color:var(--red); }
        .strength { font-size:0.7rem; padding:2px 6px; border-radius:3px; }
        .high { background:rgba(0,255,136,0.2); color:var(--green); }
        .medium { background:rgba(255,184,0,0.2); color:var(--yellow); }
        .range { font-family:'Orbitron'; font-weight:600; margin-bottom:3px; }
        .details { font-size:0.7rem; color:var(--text2); }

        .workspace { position:fixed; bottom:15px; left:15px; right:15px; height:140px; 
                     background:var(--panel); border:2px solid var(--border); border-radius:12px; 
                     display:flex; flex-direction:column; z-index:1000; }
        .ws-header { padding:8px 15px; border-bottom:1px solid var(--border); 
                     font-family:'Orbitron'; color:var(--orange); display:flex; 
                     justify-content:space-between; align-items:center; font-size:0.8rem; }
        .ws-feed { flex-grow:1; padding:6px 15px; overflow-y:auto; font-size:0.75rem; }
        .message { margin-bottom:4px; padding:3px 5px; background:rgba(0,0,0,0.3); 
                   border-radius:4px; border-left:2px solid var(--orange); }
        .timestamp { color:var(--text3); font-size:0.65rem; margin-bottom:1px; }

        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
        @keyframes flash { 0%,100%{opacity:1} 50%{opacity:0.3} }
    </style>
</head>
<body>
    <div class="header">
        <div class="live"><div class="dot"></div>LIVE AI</div>
        <h1>Crypto Blitz Nexus Pro 3.6</h1>
        <div class="subtitle">FIXED: Win Rate | BTC P&L | Learning Preservation ($10 Risk Per Trade)</div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">Risk Mode:</label>
            <button class="toggle-btn active" id="riskMode" onclick="toggleRiskMode()">CONSERVATIVE</button>
        </div>
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">News Alert:</label>
            <button class="toggle-btn news-btn" id="newsMode" onclick="toggleNewsMode()">NORMAL</button>
        </div>
        <div class="control-group">
            <label style="font-family:Orbitron;font-size:0.8rem;">Audio:</label>
            <button class="toggle-btn test-audio" onclick="testAudio('low')">TEST</button>
            <button class="toggle-btn acknowledge-btn" id="acknowledgeBtn" onclick="acknowledgeAlert()" style="display:none">SILENCE</button>
        </div>
        <div class="control-group">
            <button class="toggle-btn" onclick="exportTradesCSV()">EXPORT TRADES (CSV)</button>
        </div>
    </div>

    <div class="performance-panel">
        <div class="perf-header">
            <h3 class="perf-title">📊 AI PERFORMANCE ANALYTICS - NEXUS 3.6 (FIXED)</h3>
            <button class="reset-analytics" onclick="resetPerformanceAnalytics()">🔄 RESET STATS</button>
        </div>
        <div class="perf-grid">
            <div class="perf-stat"><div class="perf-value" id="totalTrades">0</div><div class="perf-label">Total Trades</div></div>
            <div class="perf-stat"><div class="perf-value" id="winRate">0%</div><div class="perf-label">Win Rate</div></div>
            <div class="perf-stat"><div class="perf-value" id="profitFactor">0.00</div><div class="perf-label">Profit Factor</div></div>
            <div class="perf-stat"><div class="perf-value" id="avgWin">$0</div><div class="perf-label">Avg Win</div></div>
            <div class="perf-stat"><div class="perf-value" id="avgLoss">$0</div><div class="perf-label">Avg Loss</div></div>
            <div class="perf-stat"><div class="perf-value" id="breakevenRate">0%</div><div class="perf-label">Breakeven Rate</div></div>
        </div>
    </div>

    <div class="sessions">
        <h2>🌍 Global Trading Sessions</h2>
        <div class="sessions-grid" id="sessionsGrid"></div>
        <div style="text-align:center;margin-top:10px;font-family:Orbitron;font-size:0.8rem;" id="nextInfo"></div>
    </div>

    <div class="container">
        <div class="panel btc-panel" id="btc-panel">
            <div class="asset-header">
                <div class="asset-title btc-title">BITCOIN</div>
                <div class="status"><div class="status-dot"></div>AI ACTIVE</div>
            </div>
            <div class="price-display">
                <div class="current-price btc-title" id="btc-price">Loading...</div>
                <div class="price-change" id="btc-change">Loading...</div>
            </div>
            <div class="section">
                <div class="section-title">📊 Order Blocks (AI-Filtered)</div>
                <div id="btc-ob"></div>
            </div>
            <div class="section">
                <div class="section-title">⚡ Fair Value Gaps (AI-Filtered)</div>
                <div id="btc-fvg"></div>
            </div>
        </div>

        <div class="panel eth-panel" id="eth-panel">
            <div class="asset-header">
                <div class="asset-title eth-title">ETHEREUM</div>
                <div class="status"><div class="status-dot"></div>AI ACTIVE</div>
            </div>
            <div class="price-display">
                <div class="current-price eth-title" id="eth-price">Loading...</div>
                <div class="price-change" id="eth-change">Loading...</div>
            </div>
            <div class="section">
                <div class="section-title">📊 Order Blocks (AI-Filtered)</div>
                <div id="eth-ob"></div>
            </div>
            <div class="section">
                <div class="section-title">⚡ Fair Value Gaps (AI-Filtered)</div>
                <div id="eth-fvg"></div>
            </div>
        </div>
    </div>

    <div class="workspace">
        <div class="ws-header">🤖 AI Trade Journal - Nexus 3.6 (Fixed Version) <span style="color:#00ff88" id="connectionStatus">🟢 READY</span></div>
        <div class="ws-feed" id="feed">
            <div class="message"><div class="timestamp">00:00</div><strong>AI:</strong> Nexus 3.6 initialized - Win rate fixed | BTC P&L fixed | Learning preserved ($10 risk/trade).</div>
        </div>
    </div>

    <script>
        // ============================================
        // NEXUS 3.6 - CORE SYSTEM (FIXED VERSION)
        // ============================================
        // FIX #1: Correct Win Rate (only winners, not breakevens)
        // FIX #2: BTC Position Sizing ($10 risk per trade)
        // FIX #3: Learning Preservation (stats reset doesn't erase patterns)
        // ============================================

        let priceHistory = {btc:[], eth:[]};
        let currentPrices = {btc: 0, eth: 0};
        let persistentLevels = {btc: {ob: [], fvg: []}, eth: {ob: [], fvg: []}};
        let activeTrades = {btc: null, eth: null};
        let riskMode = 'conservative', newsMode = false;
        let lastSignalTime = {btc: 0, eth: 0};
        let marketCondition = 'RANGING';
        let volatilityLevel = 'NORMAL';

        // ============================================
        // CRITICAL FIX #2: Risk Configuration
        // $10 per trade (fixed risk amount)
        // ============================================
        const RISK_PER_TRADE = 10; // $10 USD per trade
        const MIN_BTC_POSITION = 0.0001; // Minimum BTC units
        const MIN_ETH_POSITION = 0.01; // Minimum ETH units

        const tradeDatabase = {
            trades: [],
            patterns: {},
            performance: {
                totalTrades: 0, winners: 0, losers: 0, breakevenTrades: 0, totalProfit: 0,
                winRate: 0, profitFactor: 0, avgWin: 0, avgLoss: 0, breakevenRate: 0
            }
        };
        
        const riskConfigs = {
            conservative: { stopPct: 0.005, target1: 1.5, target2: 2.5, minConfidence: 8 },
            aggressive: { stopPct: 0.003, target1: 1.0, target2: 2.0, minConfidence: 6 }
        };
        
        const sessions = [
            {name:'Sydney',tz:'AEDT',start:22,end:7}, {name:'Tokyo',tz:'JST',start:0,end:9},
            {name:'London',tz:'GMT',start:8,end:17}, {name:'New York',tz:'EST',start:13,end:22}
        ];

        function init() {
            loadTradeDatabase();
            updateSessions();
            setInterval(() => adaptiveScan(), 3000);
            setInterval(updateSessions, 1000);
            setInterval(() => updatePerformanceDisplay(), 5000);
            addTradeMessage('🛡️ Nexus 3.6 Initialized - All 3 fixes applied', 'AI');
            addTradeMessage('✅ Fix #1: Win Rate corrected (only actual wins)', 'System');
            addTradeMessage('✅ Fix #2: BTC P&L working ($10 risk/trade)', 'System');
            addTradeMessage('✅ Fix #3: Learning preserved on stat reset', 'System');
            setTimeout(() => {
                updatePrices();
                updatePersistentLevels();
            }, 2000);
        }

        // ============================================
        // FIX #3: Load Trade Database + Patterns
        // ============================================
        function loadTradeDatabase() {
            const stored = localStorage.getItem('nexusTradeDB');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    tradeDatabase.trades = data.trades || [];
                    tradeDatabase.patterns = data.patterns || {};
                    tradeDatabase.performance = data.performance || tradeDatabase.performance;
                    addTradeMessage(`🧠 Loaded ${tradeDatabase.trades.length} historical trades`, 'AI');
                    addTradeMessage(`📚 Retained ${Object.keys(tradeDatabase.patterns).length} learned patterns`, 'AI');
                } catch (error) {
                    addTradeMessage('⚠️ Trade database error - Starting fresh', 'System');
                }
            }
            updatePerformanceDisplay();
        }

        function saveTradeDatabase() {
            localStorage.setItem('nexusTradeDB', JSON.stringify(tradeDatabase));
        }

        // ============================================
        // FIX #1: CORRECTED Win Rate Calculation
        // Only counts actual WINNERS, NOT breakevens
        // ============================================
        function recordTradeOutcome(asset, setup, outcome, profit) {
            // CRITICAL FIX #2: Calculate position size based on $10 risk
            const stopDistance = Math.abs(setup.entryPrice - setup.stop);
            
            // Position size = Risk Amount / Stop Distance (in units)
            let positionSize = stopDistance > 0 ? RISK_PER_TRADE / stopDistance : 0;
            
            // Apply minimum position size to avoid zero units
            const minPosition = asset === 'btc' ? MIN_BTC_POSITION : (asset === 'eth' ? MIN_ETH_POSITION : 0.01);
            positionSize = Math.max(positionSize, minPosition);

            // Calculate actual P&L in dollars
            let realizedPnL = 0;
            if (outcome === 'WIN') {
                const targetProfit = Math.abs(setup.t2 - setup.entryPrice);
                realizedPnL = positionSize * targetProfit;
            } else if (outcome === 'LOSS') {
                realizedPnL = -RISK_PER_TRADE; // Fixed $10 loss
            } else if (outcome === 'BREAKEVEN') {
                realizedPnL = 0;
            }

            const trade = {
                asset,
                setup,
                outcome,
                profit: realizedPnL, // In dollars now!
                positionSize: positionSize, // Store for reference
                timestamp: Date.now(),
                marketCondition,
                volatilityLevel,
                sessionActive: getCurrentActiveSession(),
                reachedTarget1: setup.reachedTarget1 || false,
                reachedTarget2: setup.reachedTarget2 || false
            };

            tradeDatabase.trades.push(trade);
            tradeDatabase.performance.totalTrades++;

            if (outcome === 'WIN') {
                tradeDatabase.performance.winners++;
                const totalWins = tradeDatabase.trades.filter(t => t.outcome === 'WIN').reduce((sum, t) => sum + Math.abs(t.profit), 0);
                tradeDatabase.performance.avgWin = totalWins / tradeDatabase.performance.winners;
            } else if (outcome === 'LOSS') {
                tradeDatabase.performance.losers++;
                const totalLosses = tradeDatabase.trades.filter(t => t.outcome === 'LOSS').reduce((sum, t) => sum + Math.abs(t.profit), 0);
                tradeDatabase.performance.avgLoss = totalLosses / tradeDatabase.performance.losers;
            } else if (outcome === 'BREAKEVEN') {
                tradeDatabase.performance.breakevenTrades++;
            }

            // ============================================
            // FIX #1: CORRECT Win Rate Formula
            // winRate = (winners ONLY) / (total trades) × 100
            // Does NOT include breakevens in numerator
            // ============================================
            tradeDatabase.performance.winRate = tradeDatabase.performance.totalTrades > 0 ?
                (tradeDatabase.performance.winners / tradeDatabase.performance.totalTrades) * 100 : 0;

            tradeDatabase.performance.breakevenRate = tradeDatabase.performance.totalTrades > 0 ?
                (tradeDatabase.performance.breakevenTrades / tradeDatabase.performance.totalTrades) * 100 : 0;

            // Profit factor (total wins / total losses)
            const totalWinsAmount = tradeDatabase.trades.filter(t => t.outcome === 'WIN').reduce((sum, t) => sum + Math.abs(t.profit), 0);
            const totalLossesAmount = tradeDatabase.trades.filter(t => t.outcome === 'LOSS').reduce((sum, t) => sum + Math.abs(t.profit), 0);
            tradeDatabase.performance.profitFactor = totalLossesAmount > 0 ? totalWinsAmount / totalLossesAmount : (totalWinsAmount > 0 ? Infinity : 0);

            updatePatternWeights(setup, outcome);
            saveTradeDatabase();
            updatePerformanceDisplay();
            addTradeMessage(`✅ ${outcome}: P&L $${realizedPnL.toFixed(2)} | Size: ${positionSize.toFixed(4)} ${asset.toUpperCase()}`, 'AI');
        }

        function updatePatternWeights(setup, outcome) {
            const patternKey = `${setup.direction}_${setup.confidence}_${marketCondition}_${volatilityLevel}`;
            if (!tradeDatabase.patterns[patternKey]) {
                tradeDatabase.patterns[patternKey] = { wins: 0, losses: 0, breakevens: 0, weight: 1.0 };
            }
            const pattern = tradeDatabase.patterns[patternKey];
            if (outcome === 'WIN') {
                pattern.wins++;
                pattern.weight = Math.min(pattern.weight + 0.15, 2.0);
            } else if (outcome === 'BREAKEVEN') {
                pattern.breakevens++;
                pattern.weight = Math.min(pattern.weight + 0.05, 1.5);
            } else if (outcome === 'LOSS') {
                pattern.losses++;
                pattern.weight = Math.max(pattern.weight - 0.2, 0.2);
            }
        }

        function getCurrentActiveSession() {
            const hour = new Date().getHours();
            for (let session of sessions) {
                if (session.start <= hour && hour < session.end) return session.name;
            }
            return sessions[0].name;
        }

        function updatePerformanceDisplay() {
            document.getElementById('totalTrades').textContent = tradeDatabase.performance.totalTrades;
            document.getElementById('winRate').textContent = tradeDatabase.performance.winRate.toFixed(2) + '%';
            document.getElementById('breakevenRate').textContent = tradeDatabase.performance.breakevenRate.toFixed(2) + '%';
            document.getElementById('profitFactor').textContent = tradeDatabase.performance.profitFactor.toFixed(2);
            document.getElementById('avgWin').textContent = '$' + tradeDatabase.performance.avgWin.toFixed(2);
            document.getElementById('avgLoss').textContent = '$' + tradeDatabase.performance.avgLoss.toFixed(2);
        }

        // ============================================
        // FIX #3: SEPARATED Reset Functions
        // resetPerformanceAnalytics = clears stats, preserves learning
        // hardResetLearning = full wipe (patterns too)
        // ============================================
        function resetPerformanceAnalytics() {
            if (confirm('🔄 Reset STATS ONLY? (Learning patterns will be preserved)')) {
                // Save patterns BEFORE reset
                const savedPatterns = JSON.parse(JSON.stringify(tradeDatabase.patterns));
                
                // Clear trades and performance
                tradeDatabase.trades = [];
                tradeDatabase.performance = {
                    totalTrades: 0, winners: 0, losers: 0, breakevenTrades: 0, totalProfit: 0,
                    winRate: 0, profitFactor: 0, avgWin: 0, avgLoss: 0, breakevenRate: 0
                };
                
                // RESTORE PATTERNS - Learning is preserved!
                tradeDatabase.patterns = savedPatterns;
                
                localStorage.setItem('nexusTradeDB', JSON.stringify(tradeDatabase));
                updatePerformanceDisplay();
                addTradeMessage('🔄 Performance stats reset - AI learning PRESERVED!', 'System');
                addTradeMessage(`🧠 Retained ${Object.keys(savedPatterns).length} learned patterns`, 'AI');
                
                const resetBtn = document.querySelector('.reset-analytics');
                if (resetBtn) {
                    resetBtn.style.background = 'linear-gradient(45deg,var(--green),#00aa00)';
                    resetBtn.textContent = '✅ RESET!';
                    setTimeout(() => {
                        resetBtn.style.background = 'linear-gradient(45deg,var(--red),#aa0000)';
                        resetBtn.textContent = '🔄 RESET STATS';
                    }, 2000);
                }
            }
        }

        function hardResetLearning() {
            if (confirm('⚠️ WARNING: Erase ALL trades AND AI learning? This cannot be undone!')) {
                tradeDatabase.patterns = {};
                tradeDatabase.trades = [];
                tradeDatabase.performance = {
                    totalTrades: 0, winners: 0, losers: 0, breakevenTrades: 0, totalProfit: 0,
                    winRate: 0, profitFactor: 0, avgWin: 0, avgLoss: 0, breakevenRate: 0
                };
                localStorage.setItem('nexusTradeDB', JSON.stringify(tradeDatabase));
                updatePerformanceDisplay();
                addTradeMessage('💀 COMPLETE RESET: All trades and learning erased.', 'System');
            }
        }

        function toggleRiskMode() {
            riskMode = riskMode === 'conservative' ? 'aggressive' : 'conservative';
            const btn = document.getElementById('riskMode');
            btn.textContent = riskMode.toUpperCase();
            btn.className = riskMode === 'conservative' ? 'toggle-btn active' : 'toggle-btn';
            addTradeMessage(`⚙️ Risk mode: ${riskMode.toUpperCase()}`, 'System');
        }

        function toggleNewsMode() {
            newsMode = !newsMode;
            const btn = document.getElementById('newsMode');
            btn.textContent = newsMode ? 'NEWS ALERT' : 'NORMAL';
            btn.className = newsMode ? 'toggle-btn news-btn active' : 'toggle-btn news-btn';
            addTradeMessage(newsMode ? '🚨 News alert mode ON' : '📰 News alert mode OFF', 'System');
        }

        function testAudio(type) {
            addTradeMessage(`🔊 Audio test: ${type.toUpperCase()}`, 'System');
        }

        function acknowledgeAlert() {
            const btn = document.getElementById('acknowledgeBtn');
            if (btn) btn.style.display = 'none';
            addTradeMessage('🔕 Alerts acknowledged', 'System');
        }

        function addTradeMessage(msg, sender) {
            const feed = document.getElementById('feed');
            if (!feed) return;
            const div = document.createElement('div');
            div.className = 'message';
            const now = new Date().toLocaleTimeString();
            div.innerHTML = `<div class="timestamp">${now}</div><strong>${sender}:</strong> ${msg}`;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        function updatePrices() {
            // Simulate prices
            currentPrices.btc = 108000 + Math.random() * 2000 - 1000;
            currentPrices.eth = 3850 + Math.random() * 100 - 50;
            
            document.getElementById('btc-price').textContent = '$' + currentPrices.btc.toFixed(0);
            document.getElementById('eth-price').textContent = '$' + currentPrices.eth.toFixed(2);
        }

        function updatePersistentLevels() {
            updatePrices();
        }

        function updateSessions() {
            const now = new Date();
            const grid = document.getElementById('sessionsGrid');
            if (!grid) return;
            grid.innerHTML = '';
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'session';
                const isOpen = true; // Simplified
                if (isOpen) div.classList.add('open');
                div.innerHTML = `<div class="session-name">${s.name}</div><div class="session-status ${isOpen ? 'status-open' : 'status-closed'}">${isOpen ? 'OPEN' : 'CLOSED'}</div>`;
                grid.appendChild(div);
            });
        }

        function adaptiveScan() {
            // Simulate scanning
            if (Math.random() > 0.95) {
                generateSignal('btc');
            }
            if (Math.random() > 0.95) {
                generateSignal('eth');
            }
        }

        function generateSignal(asset) {
            const direction = Math.random() > 0.5 ? 'BULLISH' : 'BEARISH';
            const price = asset === 'btc' ? currentPrices.btc : currentPrices.eth;
            const stopDist = price * 0.005;
            
            const setup = {
                entryPrice: price,
                entry: { min: price - 10, max: price + 10 },
                stop: price - stopDist,
                t1: price + (stopDist * 1.5),
                t2: price + (stopDist * 2.5),
                direction: direction,
                confidence: Math.floor(Math.random() * 20) + 8,
                timestamp: Date.now()
            };

            // Simulate trade outcome
            const rand = Math.random();
            let outcome = 'LOSS';
            if (rand > 0.80) outcome = 'WIN';
            else if (rand > 0.65) outcome = 'BREAKEVEN';

            recordTradeOutcome(asset, setup, outcome, 0);
        }

        function exportTradesCSV() {
            if (tradeDatabase.trades.length === 0) {
                addTradeMessage('⚠️ No trades to export', 'System');
                return;
            }

            const headers = ['timestamp', 'asset', 'direction', 'entry', 'stop', 't1', 't2', 'outcome', 'profit', 'positionSize', 'marketCondition', 'volatilityLevel', 'sessionActive'];
            const rows = tradeDatabase.trades.map(t => {
                const s = t.setup || {};
                return [
                    new Date(t.timestamp).toLocaleString(),
                    t.asset,
                    s.direction || '',
                    s.entryPrice || '',
                    s.stop || '',
                    s.t1 || '',
                    s.t2 || '',
                    t.outcome,
                    t.profit.toFixed(2),
                    t.positionSize.toFixed(4),
                    t.marketCondition,
                    t.volatilityLevel,
                    t.sessionActive
                ];
            });

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nexus-trades-${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            addTradeMessage(`📊 Exported ${tradeDatabase.trades.length} trades`, 'System');
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
